# Terraform Makefile for CSA Infrastructure
# Provides common operations with safety checks and best practices

.PHONY: help init plan apply destroy validate fmt check clean

# Default target
help:
	@echo "Available targets:"
	@echo "  init      - Initialize Terraform"
	@echo "  validate  - Validate Terraform configuration"
	@echo "  fmt       - Format Terraform files"
	@echo "  check     - Run validate and fmt checks"
	@echo "  plan      - Generate and show an execution plan"
	@echo "  apply     - Build or change infrastructure"
	@echo "  destroy   - Destroy Terraform-managed infrastructure"
	@echo "  clean     - Clean up Terraform files"
	@echo ""
	@echo "Environment variables:"
	@echo "  TF_VAR_file=path  - Specify tfvars file (default: terraform.tfvars)"

# Variables
TF_VAR_FILE ?= terraform.tfvars

# Check if tfvars file exists
check-tfvars:
	@if [ ! -f "$(TF_VAR_FILE)" ]; then \
		echo "âŒ Error: $(TF_VAR_FILE) not found!"; \
		echo "ğŸ“ Please copy terraform.tfvars.example to $(TF_VAR_FILE) and customize it"; \
		exit 1; \
	fi

# Initialize Terraform
init:
	@echo "ğŸš€ Initializing Terraform..."
	terraform init

# Validate configuration
validate: init
	@echo "âœ… Validating Terraform configuration..."
	terraform validate

# Format Terraform files
fmt:
	@echo "ğŸ¨ Formatting Terraform files..."
	terraform fmt -recursive

# Check formatting and validation
check: fmt validate
	@echo "âœ… All checks passed!"

# Generate execution plan
plan: check check-tfvars
	@echo "ğŸ“‹ Generating Terraform execution plan..."
	terraform plan -var-file="$(TF_VAR_FILE)" -out=tfplan

# Apply changes (requires confirmation)
apply: check check-tfvars
	@echo "ğŸ—ï¸ Applying Terraform changes..."
	@echo "âš ï¸  This will create/modify/destroy AWS resources!"
	@echo "ğŸ’° Review the plan carefully to avoid unexpected costs!"
	@read -p "Are you sure you want to continue? [y/N] " confirm && [ "$$confirm" = "y" ]
	terraform apply -var-file="$(TF_VAR_FILE)"

# Apply with auto-approval (use with caution!)
apply-auto: check check-tfvars
	@echo "ğŸ—ï¸ Auto-applying Terraform changes..."
	terraform apply -var-file="$(TF_VAR_FILE)" -auto-approve

# Destroy infrastructure (requires double confirmation)
destroy: check check-tfvars
	@echo "ğŸ’¥ Destroying Terraform-managed infrastructure..."
	@echo "âš ï¸  This will PERMANENTLY DELETE all resources!"
	@echo "ğŸ—„ï¸  S3 buckets with Object Lock CANNOT be deleted!"
	@echo "ğŸ’¸ This may result in data loss and ongoing costs!"
	@read -p "Type 'destroy' to confirm: " confirm && [ "$$confirm" = "destroy" ]
	@read -p "Are you absolutely sure? [y/N] " confirm2 && [ "$$confirm2" = "y" ]
	terraform destroy -var-file="$(TF_VAR_FILE)"

# Show current state
show:
	@echo "ğŸ“Š Showing Terraform state..."
	terraform show

# List resources
list:
	@echo "ğŸ“‹ Listing Terraform resources..."
	terraform state list

# Get outputs
output:
	@echo "ğŸ“¤ Terraform outputs:"
	terraform output

# Import existing resource (requires RESOURCE and ID parameters)
import:
	@if [ -z "$(RESOURCE)" ] || [ -z "$(ID)" ]; then \
		echo "âŒ Usage: make import RESOURCE=aws_s3_bucket.example ID=bucket-name"; \
		exit 1; \
	fi
	terraform import $(RESOURCE) $(ID)

# Clean up temporary files
clean:
	@echo "ğŸ§¹ Cleaning up Terraform files..."
	rm -f tfplan
	rm -f terraform.tfstate.backup
	rm -f .terraform.lock.hcl
	rm -rf .terraform/

# Emergency state unlock (use only if state is stuck)
unlock:
	@if [ -z "$(LOCK_ID)" ]; then \
		echo "âŒ Usage: make unlock LOCK_ID=lock-id-from-error"; \
		exit 1; \
	fi
	terraform force-unlock $(LOCK_ID)

# Refresh state without making changes
refresh: check-tfvars
	@echo "ğŸ”„ Refreshing Terraform state..."
	terraform refresh -var-file="$(TF_VAR_FILE)"

# Taint a resource to force recreation
taint:
	@if [ -z "$(RESOURCE)" ]; then \
		echo "âŒ Usage: make taint RESOURCE=aws_lambda_function.api"; \
		exit 1; \
	fi
	terraform taint $(RESOURCE)

# Untaint a resource
untaint:
	@if [ -z "$(RESOURCE)" ]; then \
		echo "âŒ Usage: make untaint RESOURCE=aws_lambda_function.api"; \
		exit 1; \
	fi
	terraform untaint $(RESOURCE)

# Graph visualization (requires graphviz)
graph:
	@echo "ğŸ“ˆ Generating Terraform dependency graph..."
	terraform graph | dot -Tpng > terraform-graph.png
	@echo "Graph saved as terraform-graph.png"

# Cost estimation (requires infracost CLI)
cost:
	@if ! command -v infracost >/dev/null 2>&1; then \
		echo "âŒ infracost CLI not found. Install from: https://www.infracost.io/docs/"; \
		exit 1; \
	fi
	@echo "ğŸ’° Estimating infrastructure costs..."
	infracost breakdown --path .

# Security scan (requires checkov CLI)
security:
	@if ! command -v checkov >/dev/null 2>&1; then \
		echo "âŒ checkov CLI not found. Install with: pip install checkov"; \
		exit 1; \
	fi
	@echo "ğŸ”’ Running security scan..."
	checkov -d .

# Full workflow: format, validate, plan
workflow: fmt validate plan
	@echo "ğŸ¯ Workflow complete! Review the plan before applying."